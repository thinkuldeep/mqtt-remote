<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <title>MQTT Remote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <link rel="stylesheet" href="style.css">

</head>
<body class="main">
<div>
    Connection URL: <input name ="url" id="url" placeholder="Enter Connection URL" value="ws://localhost:8883/mqtt"/>
    Topic: <input name ="command" id="command" placeholder="Enter Topic" value="/command"/>
    <br>
    <button id="setup" onclick="setup()" class="button-green">Setup</button>

    <h2 id="header1">MQTT Remote</h2>
    <br>
    <button id="remote-control" onclick="remoteControl()" class="button-green">Switch OFF</button>
    <h4 id="logger"></h4>
</div>

</body>
<script>
    // An mqtt variable will be initialized globally
    console.log(mqtt)
    $('#remote-control').hide();
    const log = $('#logger');
    let client = null;
    let topic = null;

    function setup() {
        url = $('#url').val()
        command = $('#command').val()
        console.log(url, command)
        if(url && command) {
            $('#remote-control').hide();

            client = connect(url, command)
            listen(client)
            topic = command;
        }
        $('#remote-control').show();
    }

    function connect(url, topic){
        log.html('Connecting...');
        const client  = mqtt.connect(url)
        client.on('connect', function () {
            log.html('Connected.')
            // Subscribe to a topic
            client.subscribe(topic, function (err) {
                console.log(err)
                if (!err) {
                    // Publish a message to a topic
                    log.html('Switching ON...');
                    client.publish(topic, 'ON')
                }
            })
        })

        return client;
    }
    // Receive messages
    function listen(client) {
        client.on('message', function (topic, message) {
            button =  $('#remote-control');
            // message is Buffer
            console.log(message.toString())
            if (message.toString() === 'ON_OK') {
                console.log('Switch ON')
                if(button.hasClass('button-green')) {
                    button.removeClass('button-green')
                    button.addClass('button-red')
                    button.text('Switch OFF')
                    $('.main').css('background-color', 'green')
                }
                log.html('Switched ON');
                button.enabled = true;
            } else if(message.toString() === 'OFF_OK') {
                console.log('Switch OFF')
                if(button.hasClass('button-red')) {
                    button.removeClass('button-red')
                    button.addClass('button-green')
                    button.text('Switch ON')
                    $('.main').css('background-color', 'red')
                }
                log.html('Switched OFF');
                button.enabled = true;
            }
        })

        client.on('error', function (error) {
            console.log('Can not connect', error)
            log.html('Can not connect...');
            client.end();
        })
    }

    function remoteControl() {
        button = $('#remote-control');
        if(button.hasClass('button-red')) {
            log.html('Switching OFF...');
            button.enabled = false;
            client.publish(topic, 'OFF')
        } else {
            log.html('Switching ON...');
            button.enabled = false;
            client.publish(topic, 'ON')
        }
    }

</script>
</html>
